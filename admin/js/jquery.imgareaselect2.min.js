//Ver 0.6.1
jQuery.imgAreaSelect2={onKeyPress:null};jQuery.imgAreaSelect2.init=function(img,options){var $area=jQuery('<div></div>'),$border1=jQuery('<div></div>'),$border2=jQuery('<div></div>'),$outLeft=jQuery('<div></div>'),$outTop=jQuery('<div></div>'),$outRight=jQuery('<div></div>'),$outBottom=jQuery('<div></div>'),left,top,imgOfs,imgWidth,imgHeight,parent,parOfs,parScroll,adjusted,zIndex=0,fixed,$p,startX,startY,moveX,moveY,resizeMargin=10,resize=[],V=0,H=1,keyDown,d,aspectRatio,tx1,tx2,ty1,ty2,tx,ty,selection={tx1:0,ty1:0,tx2:0,ty2:0,width:0,height:0};var $a=$area.add($border1).add($border2);var $o=$outLeft.add($outTop).add($outRight).add($outBottom);function viewX(tx){return tx+imgOfs.left+parScroll.left-parOfs.left}function viewY(ty){return ty+imgOfs.top+parScroll.top-parOfs.top}function selX(tx){return tx-imgOfs.left-parScroll.left+parOfs.left}function selY(ty){return ty-imgOfs.top-parScroll.top+parOfs.top}function evX(event){return event.pageX+parScroll.left-parOfs.left}function evY(event){return event.pageY+parScroll.top-parOfs.top}function adjust(){imgOfs=jQuery(img).offset();imgWidth=jQuery(img).width();imgHeight=jQuery(img).height();if(jQuery(parent).is('body'))parOfs=parScroll={left:0,top:0};else{parOfs=jQuery(parent).offset();parScroll={left:parent.scrollLeft,top:parent.scrollTop}}left=viewX(0);top=viewY(0)}function update(resetKeyPress){$a.css({left:viewX(selection.tx1)+'px',top:viewY(selection.ty1)+'px',width:Math.max(selection.width-options.borderWidth*2,0)+'px',height:Math.max(selection.height-options.borderWidth*2,0)+'px'});$outLeft.css({left:left+'px',top:top+'px',width:selection.tx1+'px',height:imgHeight+'px'});$outTop.css({left:left+selection.tx1+'px',top:top+'px',width:selection.width+'px',height:selection.ty1+'px'});$outRight.css({left:left+selection.tx2+'px',top:top+'px',width:imgWidth-selection.tx2+'px',height:imgHeight+'px'});$outBottom.css({left:left+selection.tx1+'px',top:top+selection.ty2+'px',width:selection.width+'px',height:imgHeight-selection.ty2+'px'});if(resetKeyPress!==false){if(jQuery.imgAreaSelect2.keyPress!=docKeyPress)jQuery(document).unbind(jQuery.imgAreaSelect2.keyPress,jQuery.imgAreaSelect2.onKeyPress);if(options.keys)jQuery(document).bind(jQuery.imgAreaSelect2.keyPress,jQuery.imgAreaSelect2.onKeyPress=docKeyPress)}}function areaMouseMove(event){if(!adjusted){adjust();adjusted=true;$a.one('mouseout',function(){adjusted=false})}tx=selX(evX(event))-selection.tx1;ty=selY(evY(event))-selection.ty1;resize=[];if(options.resizable){if(ty<=resizeMargin)resize[V]='n';else if(ty>=selection.height-resizeMargin)resize[V]='s';if(tx<=resizeMargin)resize[H]='w';else if(tx>=selection.width-resizeMargin)resize[H]='e'}$border2.css('cursor',resize.length?resize.join('')+'-resize':options.movable?'move':'')}function areaMouseDown(event){if(event.which!=1)return false;adjust();if(options.resizable&&resize.length>0){jQuery('body').css('cursor',resize.join('')+'-resize');tx1=viewX(resize[H]=='w'?selection.tx2:selection.tx1);ty1=viewY(resize[V]=='n'?selection.ty2:selection.ty1);jQuery(document).mousemove(selectingMouseMove);$border2.unbind('mousemove',areaMouseMove);jQuery(document).one('mouseup',function(){resize=[];jQuery('body').css('cursor','');if(options.autoHide)$a.add($o).hide();options.onSelectEnd(img,selection);jQuery(document).unbind('mousemove',selectingMouseMove);$border2.mousemove(areaMouseMove)})}else if(options.movable){moveX=selection.tx1+left;moveY=selection.ty1+top;startX=evX(event);startY=evY(event);jQuery(document).mousemove(movingMouseMove).one('mouseup',function(){options.onSelectEnd(img,selection);jQuery(document).unbind('mousemove',movingMouseMove)})}else jQuery(img).mousedown(event);return false}function aspectRatioXY(){tx2=Math.max(left,Math.min(left+imgWidth,tx1+Math.abs(ty2-ty1)*aspectRatio*(tx2>=tx1?1:-1)));ty2=Math.round(Math.max(top,Math.min(top+imgHeight,ty1+Math.abs(tx2-tx1)/aspectRatio*(ty2>=ty1?1:-1))));tx2=Math.round(tx2)}function aspectRatioYX(){ty2=Math.max(top,Math.min(top+imgHeight,ty1+Math.abs(tx2-tx1)/aspectRatio*(ty2>=ty1?1:-1)));tx2=Math.round(Math.max(left,Math.min(left+imgWidth,tx1+Math.abs(ty2-ty1)*aspectRatio*(tx2>=tx1?1:-1))));ty2=Math.round(ty2)}function doResize(newX2,newY2){tx2=newX2;ty2=newY2;if(options.minWidth&&Math.abs(tx2-tx1)<options.minWidth){tx2=tx1-options.minWidth*(tx2<tx1?1:-1);if(tx2<left)tx1=left+options.minWidth;else if(tx2>left+imgWidth)tx1=left+imgWidth-options.minWidth}if(options.minHeight&&Math.abs(ty2-ty1)<options.minHeight){ty2=ty1-options.minHeight*(ty2<ty1?1:-1);if(ty2<top)ty1=top+options.minHeight;else if(ty2>top+imgHeight)ty1=top+imgHeight-options.minHeight}tx2=Math.max(left,Math.min(tx2,left+imgWidth));ty2=Math.max(top,Math.min(ty2,top+imgHeight));if(aspectRatio)if(Math.abs(tx2-tx1)/aspectRatio>Math.abs(ty2-ty1))aspectRatioYX();else aspectRatioXY();if(options.maxWidth&&Math.abs(tx2-tx1)>options.maxWidth){tx2=tx1-options.maxWidth*(tx2<tx1?1:-1);if(aspectRatio)aspectRatioYX()}if(options.maxHeight&&Math.abs(ty2-ty1)>options.maxHeight){ty2=ty1-options.maxHeight*(ty2<ty1?1:-1);if(aspectRatio)aspectRatioXY()}selection.tx1=selX(Math.min(tx1,tx2));selection.tx2=selX(Math.max(tx1,tx2));selection.ty1=selY(Math.min(ty1,ty2));selection.ty2=selY(Math.max(ty1,ty2));selection.width=Math.abs(tx2-tx1);selection.height=Math.abs(ty2-ty1);update();options.onSelectChange(img,selection)}function selectingMouseMove(event){tx2=!resize.length||resize[H]||aspectRatio?evX(event):viewX(selection.tx2);ty2=!resize.length||resize[V]||aspectRatio?evY(event):viewY(selection.ty2);doResize(tx2,ty2);return false}function doMove(newX1,newY1){tx2=(tx1=newX1)+selection.width;ty2=(ty1=newY1)+selection.height;selection.tx1=selX(tx1);selection.ty1=selY(ty1);selection.tx2=selX(tx2);selection.ty2=selY(ty2);update();options.onSelectChange(img,selection)}function movingMouseMove(event){var newX1=Math.max(left,Math.min(moveX+evX(event)-startX,left+imgWidth-selection.width));var newY1=Math.max(top,Math.min(moveY+evY(event)-startY,top+imgHeight-selection.height));doMove(newX1,newY1);event.preventDefault();return false}function startSelection(event){adjust();selection.tx1=selection.tx2=selX(startX=tx1=tx2=evX(event));selection.ty1=selection.ty2=selY(startY=ty1=ty2=evY(event));selection.width=0;selection.height=0;resize=[];update();$a.add($o).show();jQuery(document).unbind('mouseup',cancelSelection).mousemove(selectingMouseMove);$border2.unbind('mousemove',areaMouseMove);options.onSelectStart(img,selection);jQuery(document).one('mouseup',function(){if(options.autoHide||(selection.width*selection.height==0))$a.add($o).hide();options.onSelectEnd(img,selection);jQuery(document).unbind('mousemove',selectingMouseMove);$border2.mousemove(areaMouseMove)})}function cancelSelection(){jQuery(document).unbind('mousemove',startSelection);$a.add($o).hide()}function imgMouseDown(event){if(event.which!=1)return false;jQuery(document).one('mousemove',startSelection).one('mouseup',cancelSelection);return false}function windowResize(){adjust();update(false);tx1=viewX(selection.tx1);ty1=viewY(selection.ty1);tx2=viewX(selection.tx2);ty2=viewY(selection.ty2)}var docKeyPress=function(event){var k=options.keys,d=10,t,key=event.keyCode||event.which;if(!isNaN(k.arrows))d=k.arrows;if(!isNaN(k.shift)&&event.shiftKey)d=k.shift;if(!isNaN(k.ctrl)&&event.ctrlKey)d=k.ctrl;if(!isNaN(k.alt)&&(event.altKey||event.originalEvent.altKey))d=k.alt;if(k.arrows=='resize'||(k.shift=='resize'&&event.shiftKey)||(k.ctrl=='resize'&&event.ctrlKey)||(k.alt=='resize'&&(event.altKey||event.originalEvent.altKey))){switch(key){case 37:d=-d;case 39:t=Math.max(tx1,tx2);tx1=Math.min(tx1,tx2);tx2=Math.max(t+d,tx1);if(aspectRatio)aspectRatioYX();break;case 38:d=-d;case 40:t=Math.max(ty1,ty2);ty1=Math.min(ty1,ty2);ty2=Math.max(t+d,ty1);if(aspectRatio)aspectRatioXY();break;default:return}doResize(tx2,ty2)}else{tx1=Math.min(tx1,tx2);ty1=Math.min(ty1,ty2);switch(key){case 37:doMove(Math.max(tx1-d,left),ty1);break;case 38:doMove(tx1,Math.max(ty1-d,top));break;case 39:doMove(tx1+Math.min(d,imgWidth-selX(tx2)),ty1);break;case 40:doMove(tx1,ty1+Math.min(d,imgHeight-selY(ty2)));break;default:return}}return false};this.setOptions=function(newOptions){options=jQuery.extend(options,newOptions);if(newOptions.tx1!=null){selection.tx1=newOptions.tx1;selection.ty1=newOptions.ty1;selection.tx2=newOptions.tx2;selection.ty2=newOptions.ty2;newOptions.show=true}if(newOptions.keys)options.keys=jQuery.extend({shift:1,ctrl:'resize'},newOptions.keys===true?{}:newOptions.keys);parent=jQuery(options.parent).get(0);adjust();$p=jQuery(img);while($p.length&&!$p.is('body')){if(!isNaN($p.css('z-index'))&&$p.css('z-index')>zIndex)zIndex=$p.css('z-index');if($p.css('position')=='fixed')fixed=true;$p=$p.parent()}tx1=viewX(selection.tx1);ty1=viewY(selection.ty1);tx2=viewX(selection.tx2);ty2=viewY(selection.ty2);selection.width=tx2-tx1;selection.height=ty2-ty1;update();if(newOptions.hide)$a.add($o).hide();else if(newOptions.show)$a.add($o).show();$o.addClass(options.classPrefix+'-outer');$area.addClass(options.classPrefix+'-selection');$border1.addClass(options.classPrefix+'-border1');$border2.addClass(options.classPrefix+'-border2');$a.css({borderWidth:options.borderWidth+'px'});$area.css({backgroundColor:options.selectionColor,opacity:options.selectionOpacity});$border1.css({borderStyle:'solid',borderColor:options.borderColor1});$border2.css({borderStyle:'dashed',borderColor:options.borderColor2});$o.css({opacity:options.outerOpacity,backgroundColor:options.outerColor});aspectRatio=options.aspectRatio&&(d=options.aspectRatio.split(/:/))?d[0]/d[1]:null;if(options.disable||options.enable===false){$a.unbind('mousemove',areaMouseMove).unbind('mousedown',areaMouseDown);jQuery(img).add($o).unbind('mousedown',imgMouseDown);jQuery(window).unbind('resize',windowResize)}else if(options.enable||options.disable===false){if(options.resizable||options.movable)$a.mousemove(areaMouseMove).mousedown(areaMouseDown);if(!options.persistent)jQuery(img).add($o).mousedown(imgMouseDown);jQuery(window).resize(windowResize)}jQuery(options.parent).append($o.add($a));options.enable=options.disable=undefined};if(jQuery.browser.msie)jQuery(img).attr('unselectable','on');jQuery.imgAreaSelect2.keyPress=jQuery.browser.msie||jQuery.browser.safari?'keydown':'keypress';$a.add($o).css({display:'none',position:fixed?'fixed':'absolute',overflow:'hidden',zIndex:zIndex>0?zIndex:'0'});$area.css({borderStyle:'solid'});initOptions={borderColor1:'#000',borderColor2:'#fff',borderWidth:1,classPrefix:'imgareaselect2',movable:true,resizable:true,selectionColor:'#fff',selectionOpacity:0.2,outerColor:'#000',outerOpacity:0.2,parent:'body',onSelectStart:function(){},onSelectChange:function(){},onSelectEnd:function(){}};options=jQuery.extend(initOptions,options);this.setOptions(options)};jQuery.fn.imgAreaSelect2=function(options){options=options||{};this.each(function(){if(jQuery(this).data('imgAreaSelect2'))jQuery(this).data('imgAreaSelect2').setOptions(options);else{if(options.enable===undefined&&options.disable===undefined)options.enable=true;jQuery(this).data('imgAreaSelect2',new jQuery.imgAreaSelect2.init(this,options))}});return this};
